---
title: "HW5_Chitadze"
output: html_document
date: "2024-04-10"
---

## Тема:

построение регрессионных моделей и анализ выживаемости.

## Цель:

научиться пользоваться основными методами регрессионного анализа, разобраться с принципами анализа выживаемости.

## Описание ДЗ

Для выполнения первых двух заданий загрузите датасет Breast Cancer Wisconsin.

В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

Выполните перечисленные задания.

```{r}
# импорт библиотек
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)
```

```{r}
install.packages("survminer")
install.packages("ggsurvfit")
```

```{r}
# Загрузка и изучение типов данных датасета
cancer_data <- read.csv('/Users/alenacitadze/Downloads/wisconsin_breast_cancer.csv')
head(cancer_data)
```

## Задание 1

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
# Проверка пропущенных значений по изучаемым столбцам
colSums(is.na(cancer_data[c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean")]))
```

Пропущенных значений нет.

Зададим уровень значимости alpha = 0.05 и гипотезы:

*Н0 - зависимая переменная и фактор не имеют статистически значимой линейной зависимости*

*Н1 - зависимая переменная и фактор имеют статистически значимую линейную зависимость*

```{r}
# построение модели линейной регрессии 
fit1 <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = cancer_data) 
summary(fit1)
```

Residuals (остатки): Показывает различия между фактическими значениями и значениями, предсказанными моделью. Минимальное, максимальное и медианное значения остатков указывают на разброс ошибок модели.

Coefficients (коэффициенты): Показывает оценки коэффициентов регрессии для каждого предиктора (независимой переменной) в модели. Для каждого коэффициента выводятся оценка (Estimate), стандартная ошибка (Std. Error), t-значение (t value) и p-значение (Pr(\>\|t\|)). Значения p-значений меньше 0.05 обычно считаются статистически значимыми.

Residual standard error (стандартная ошибка остатков): Показывает стандартное отклонение остатков регрессии. Это мера того, насколько точно модель соответствует данным.

Multiple R-squared (квадрат множественного R): Показывает долю дисперсии зависимой переменной, объясненную моделью. Значение близкое к 1 указывает на хорошее соответствие модели данным.

Adjusted R-squared (скорректированный R-квадрат): Корректированный R-квадрат учитывает количество предикторов в модели. Он предпочтителен при сравнении моделей с разным количеством предикторов.

F-statistic (F-статистика): Показывает статистическую значимость всей модели. Большое значение F-статистики с низким p-значением указывает на то, что по крайней мере один из коэффициентов регрессии значимо отличается от нуля, что подтверждает статистическую значимость модели в целом.

```{r}
# Визуализация зависимости зависимой переменной и одного из факторов
cancer_data
%>%
    ggplot(aes(x = area_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и среней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний радиус опухоли") + 
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
#  Визуализация  зависимости зависимой переменной и одного из факторов
cancer_data %>%
    ggplot(aes(x = perimeter_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и сренего периметра опухоли",
      x = "Среднего периметра опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
# Визуализация  зависимости зависимой переменной и одного из факторов
cancer_data %>%
    ggplot(aes(x = symmetry_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и среней симметричности опухоли",
      x = "Средняя симметричности опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

Все факторы имеют линейную зависимость с зависимой переменной (средний радиус опухоли).

```{r}
# Оценка нормальности распределения остатков с помощью теста Шапиро-Уилка
shapiro.test(residuals(fit1))
```

В данном случае, p-значение очень мало, что может указывать на отклонение остатков от нормального распределения.

```{r}
# оценка распределения остатков 
plot(fit1, which = 1)
```

Наблюдается некоторая неравномерность распределения остатков (в одной области большая концентрация точек, в другом меньше). Для более точных результатов необходимо проводить статистические тесты.

```{r}
cancer_data %>%
    ggplot(aes(x = area_mean, y = perimeter_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и сренего периметра опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний периметр опухоли")
```

```{r}
cancer_data %>%
    ggplot(aes(x = perimeter_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего периметра и сренеей симметричности опухоли",
      x = "Средней симметричности опухоли",
      y = "Средний периметр опухоли")

```

```{r}
cancer_data %>%
    ggplot(aes(x = area_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и сренеей симметричности опухоли",
      x = "Средняя площадь опухоли",
      y = "Средняя симметричность опухоли") 
```

По графику мы видим, что есть сильная линейная зависимость между признаками средняя площадь и средний периметр. Для нашей модели это может значить то, что данные признаки сильно коррелируют друг с другом, это дает явление мультиколлинеарности и ухудшает результат модели. Поэтому для построения грамотной хорошей модели нужно убрать один из этих признаков.

Наблюдения в нашем датасете независимые, так как представлены отдельными не связанными друг с другом наблюдениями.

## Задание 2

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
# Преобразование столбца с диагнозом
cancer_data$diagnosis <- ifelse(cancer_data$diagnosis == 'M', 1, 0)

# проверка
head(select(cancer_data, diagnosis),10)
```
Зададим уровень значимости alpha = 0.05 и гипотезы:

*Н0 - зависимая переменная и фактор не имеют статистически значимой зависимости*

*Н1 - зависимая переменная и фактор имеют статистически значимую зависимость*

В нашем случае целесообразно построить модель логистической ререссии, так как зависимая переменная - категориальная.

```{r}
gfit1 <-
  glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = cancer_data, family = "binomial")
summary(gfit1)
```

Диагностика коэффициентов:

(Intercept): Не значим при уровне значимости 0.05 (p-value = 0.168), что означает, что при нулевых значениях всех предикторов логарифм отношения шансов равен 0.
radius_mean: Не значим (p-value = 0.687), что указывает на отсутствие статистически значимого влияния среднего радиуса опухоли на вероятность бинарного исхода.
area_mean: Не значим (p-value = 0.137), что указывает на отсутствие статистически значимого влияния средней площади опухоли на вероятность бинарного исхода.
texture_mean: Значим при уровне значимости 0.05 (p-value < 0.001), что указывает на статистически значимое положительное влияние средней текстуры опухоли на вероятность бинарного исхода. Каждое единичное изменение в средней текстуре опухоли приводит к увеличению логарифма отношения шансов на 0.209.
Deviance statistics:

Null deviance: 751.44, Residual deviance: 288.81. Уменьшение deviance от начальной модели до финальной свидетельствует о том, что финальная модель объясняет значительную часть изменчивости зависимой переменной.
AIC (Akaike Information Criterion):

Значение AIC для данной модели составляет 296.81. По сравнению с другими моделями, модель с более низким AIC считается более предпочтительной.

```{r}
exp(coefficients(gfit1))
```


(Intercept): Коэффициент статистически значим при уровне значимости 0.05 (p-value < 0.001), что указывает на значимое влияние этой константной составляющей на вероятность бинарного исхода.
radius_mean: Коэффициент не является статистически значимым (p-value = 0.680), что означает отсутствие значимого влияния среднего радиуса опухоли на вероятность бинарного исхода.
area_mean: Коэффициент также не является статистически значимым (p-value = 1.016), указывая на отсутствие значимого влияния средней площади опухоли на вероятность бинарного исхода.
texture_mean: Значим при уровне значимости 0.05 (p-value < 0.001), что свидетельствует о статистически значимом положительном влиянии средней текстуры опухоли на вероятность бинарного исхода. Каждое единичное изменение в средней текстуре опухоли приводит к увеличению логарифма отношения шансов на 1.23.
Модель является статистически значимой и представляет собой хорошее приближение данных, но ее прогностическая сила требует дальнейшей оценки, особенно в отношении важности предикторов.

```{r}
# визуализация кривой логистической регрессии 
cancer_data %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и сренего радиуса опухоли",
      x = "Средний радиус опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```
```{r}
# визуализация кривой логистической регрессии 
cancer_data %>%
    ggplot(aes(x = area_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и среней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
# визуализация кривой логистической регрессии 
cancer_data %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и сренего значения текстуры опухоли",
      x = "Средняя текстура опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```
Логистическая регрессионная модель, отражающая прогноз вероятности возникновения злокачественной опухоли от всех трех перечисленных факторов при их взаимодействии.

```{r}
gfit2 <-
  glm(diagnosis ~ radius_mean * area_mean * texture_mean,
      data = cancer_data,
      family = "binomial")

summary(gfit2)
```
В данной модели линейной регрессии с учетом взаимодействия переменных можно сделать следующие выводы:

(Intercept): Коэффициент при константном члене не является статистически значимым и не оказывает влияния на зависимую переменную.
radius_mean: Переменная радиуса опухоли также не оказывает статистически значимого влияния на зависимую переменную.
area_mean: Среднее значение площади опухоли также не является статистически значимым предиктором.
texture_mean: Среднее значение текстуры опухоли также не оказывает статистически значимого влияния на зависимую переменную.
Взаимодействия переменных: Коэффициенты при взаимодействиях между переменными также не являются статистически значимыми, что указывает на отсутствие влияния этих взаимодействий на зависимую переменную.
Таким образом, модель не представляет собой статистически значимого приближения данных, и необходимо исследовать другие варианты моделирования

## Задание 3
Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

inst: код учреждения;
time: время выживаемости в днях;
status: 1 = цензурирование, 2 = смерть;
age: возраст в годах;
sex: мужской = 1, женский = 2;
ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
meal.cal: калории потребляемой пищи;
wt.loss: потеря веса за последние полгода.
Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
# Загрузка и изучение датасета
lung <- survival::lung
head(lung)
```

```{r}
lung$event <- ifelse(lung$status == 2,1,0)
head(lung)
```
```{r}
# делаем выборку только тех пациентов, которые достигли целевого события (смерть)
lung_d <- filter(lung,lung$event == 1)
head(lung_d)
```


```{r}

# Построение объекта выживаемости с разделением по полу
surv_fit <- survfit(Surv(time, status) ~ sex, data = lung_d)

# Построение графика выживаемости для каждой группы
ggsurvplot(surv_fit, data = lung_d, conf.int = TRUE, risk.table = TRUE, risk.table.col = "strata")


```

На графике мы видим, что доверительные интервалы двух групп пересекаются, линии графика также пересекаются. Это может говорить об отсутсвии значимых различий между полом по выживаемости.

Зададим уровень значимости, alpha = 0.05

*Н0 - Разница в выживаемости между двумя группами отсутствует.*

*Н1 - Существует разница в выживаемости между двумя группами, разделенными по полу.*

```{r}
# Лог-ранг тест
survdiff(Surv(time, status) ~ sex, data = lung_d)
```

Не выявлено статистически значимых различий между наблюдаемыми и ожидаемыми значениями смертности по половой принадлежности

```{r}
# График кумулятивной функции рисков по полу
ggsurvplot(surv_fit, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```


На графике мы видим, что доверительные интервалы двух групп пересекаются, линии графика также пересекаются. Это может говорить об отсутсвии значимых различий между полом по уровню риска.

```{r}
# регрессия Кокса
cox <- coxph(Surv(time, status) ~ sex, data = lung_d)
summary(cox)
```
При использовании модели пропорциональных рисков Кокса было обнаружено следующее:

Коэффициент для переменной пола (sex) составил -0.2511, что указывает на то, что мужчины имеют примерно на 22.21% меньше вероятность смерти по сравнению с женщинами.
Однако значение p-value для коэффициента пола составляет 0.136, что означает, что различия в выживаемости между полами статистически незначимы при уровне значимости 0.05.
Коэффициент конкордации составил 0.543, что указывает на среднюю согласованность модели.
Тесты на значимость (критерий отношения правдоподобия, тест Вальда и тест логарифма рангов) также не позволяют отвергнуть нулевую гипотезу о том, что коэффициент пола равен нулю, при уровне значимости 0.05.
Таким образом, в данном исследовании не обнаружено статистически значимого влияния пола на вероятность смерти среди пациентов.

```{r}
# Выполнение преобразования exp(coef) и exp(-coef)
(1 - 0.7779) * 100 
(1 - 1.285) * 100 
```

То есть риск смерти в группе женщин ниже, чем у мужчин на 22.21%, а риск смерти в группе мужчин выше на 28.5%. Однако, мы знаем, что эти различия по результатам регрессии Кокса не достоверны.




